cliconfig:
  url: "ldap://ldap:1389"
  passwordfile: "config/passfile"
  base: "dc=example,dc=org"
  user: "admin"
  ldapstls:
    cafile: "/config/ca.crt"
    crtfile: "/config/ldap.crt"
    crtkeyfile: "/config/ldap.key"
  awsconfig:
    network:
      vpcname: demo.VPC
      subnetname: demo.VPC-private
      sgmanager: manager
    az: a
    instancetype: t3.medium
    region: us-east-1
    imageid: ami-053b0d53c279acc90
    userdata: |
      #!/bin/bash
      apt-get update
      curl -sfL https://get.docker.com | sh -
      curl -sfL https://get.k3s.io | sh -
      apt-get install -y xfce4 sssd xrdp git python3-pip docker-compose sssd-ldap ldap-utils sssd-tools ca-certificates
      mkdir -p /etc/sssd/certs
      cat >/etc/sssd/certs/ca.crt << 'EOF'
      ${CA.CRT}
      EOF
      cat >/etc/sssd/sssd.conf << 'EOF'
      [sssd]
      services = nss, pam
      config_file_version = 2
      domains = workshop

      [nss]
      homedir_substring = /home

      [pam]
      offline_credentials_expiration = 60

      [domain/workshop]
      cache_credentials = True
      id_provider = ldap
      auth_provider = ldap
      chpass_provider = ldap
      access_provider = ldap
      ldap_uri = ldaps://manager.workshop:1686
      ldap_search_base = ou=users,dc=example,dc=org
      ldap_default_bind_dn = cn=admin,dc=example,dc=org
      ldap_default_authtok = ${PASSWORD}
      ldap_access_filter = (objectClass=posixAccount)
      ldap_access_order = filter
      ldap_schema = rfc2307bis
      ldap_tls_reqcert = allow
      ldap_tls_cacert = /etc/sssd/certs/ca.crt
      EOF
      chmod 600 -R /etc/sssd
      chown -R root: /etc/sssd
      sssctl config-check
      systemctl restart sssd
      systemctl enable sssd
      pam-auth-update --enable mkhomedir
      addgroup ${USER} sudo
      cd /root
      git clone https://github.com/aescanero/opensouthcode-workshop-2023

